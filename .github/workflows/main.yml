name: CI Fixed Complete

on:
  workflow_dispatch:

env:
  WINDOWS_SDK_VERSION: 10.0

jobs:
  Build_x64:
    runs-on: windows-latest
    timeout-minutes: 60

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Build Tools
        run: |
          echo "=== Build Environment ==="
          echo "MSBuild: $(where msbuild)"
          echo "NuGet: $(where nuget)"

      - name: Setup msbuild
        uses: microsoft/setup-msbuild@v2

    #
    # Compile Sandboxie Core - FIXED PATHS
    #

      - name: Build Sandboxie Core x86
        run: |
          echo "=== Building x86 Components ==="
          msbuild Sandboxie\SandboxDll.sln /p:Configuration="SbieRelease" /p:Platform=Win32 -maxcpucount:4 -verbosity:minimal
          msbuild Sandboxie\Sandbox.sln /p:Configuration="SbieRelease" /p:Platform=Win32 -maxcpucount:4 -verbosity:minimal

      - name: Build Sandboxie Core x64
        run: |
          echo "=== Building x64 Components ==="
          msbuild Sandboxie\Sandbox.sln /p:Configuration="SbieRelease" /p:Platform=x64 -maxcpucount:4 -verbosity:minimal

    #
    # Debug tìm file đã build
    #

      - name: Find Built Core Files
        run: |
          echo "=== LOCATING CORE FILES ==="
          
          # Tìm trong các đường dẫn có thể
          $searchPaths = @(
            "bin",
            "x64", 
            "Win32",
            "Sandboxie\bin",
            "Sandboxie\x64",
            "Sandboxie\Win32"
          )
          
          foreach ($path in $searchPaths) {
            if (Test-Path $path) {
              echo "--- Searching in: $path ---"
              Get-ChildItem $path -Recurse -Filter "*Sbie*" -ErrorAction SilentlyContinue | Select-Object FullName, Length
            }
          }
          
          # Tìm file cụ thể
          $criticalFiles = @("SbieDll.dll", "SbieSvc.exe", "Start.exe", "SbieDrv.sys")
          foreach ($file in $criticalFiles) {
            echo "--- Searching for: $file ---"
            Get-ChildItem -Recurse -Filter $file -ErrorAction SilentlyContinue | Select-Object FullName, Length
          }

    #
    # Build các components khác
    #

      - name: Build Sandboxie-Tools x64
        run: |
          msbuild SandboxieTools\SandboxieTools.sln /p:Configuration="Release" /p:Platform=x64 -maxcpucount:4

    #
    # Tạo package với đường dẫn chính xác
    #

      - name: Create Portable Package
        run: |
          # Tạo thư mục output
          if (!(Test-Path "Installer\SbiePlus_x64")) { 
            New-Item -ItemType Directory -Path "Installer\SbiePlus_x64" -Force 
          }
          
          echo "=== COPYING FILES TO PACKAGE ==="
          
          # Tìm và copy core files - QUAN TRỌNG
          $copiedFiles = @()
          
          # Tìm SbieDll.dll
          $sbieDll = Get-ChildItem -Recurse -Filter "SbieDll.dll" -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($sbieDll) {
            copy $sbieDll.FullName "Installer\SbiePlus_x64\"
            $copiedFiles += "SbieDll.dll"
          }
          
          # Tìm SbieSvc.exe
          $sbieSvc = Get-ChildItem -Recurse -Filter "SbieSvc.exe" -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($sbieSvc) {
            copy $sbieSvc.FullName "Installer\SbiePlus_x64\"
            $copiedFiles += "SbieSvc.exe"
          }
          
          # Tìm Start.exe
          $startExe = Get-ChildItem -Recurse -Filter "Start.exe" -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($startExe) {
            copy $startExe.FullName "Installer\SbiePlus_x64\"
            $copiedFiles += "Start.exe"
          }
          
          # Tìm SbieDrv.sys
          $sbieDrv = Get-ChildItem -Recurse -Filter "SbieDrv.sys" -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($sbieDrv) {
            copy $sbieDrv.FullName "Installer\SbiePlus_x64\"
            $copiedFiles += "SbieDrv.sys"
          }
          
          # Copy Tools
          if (Test-Path "SandboxieTools\x64\Release") {
            copy "SandboxieTools\x64\Release\*" "Installer\SbiePlus_x64\" -Recurse -Force
            $copiedFiles += "Tools"
          }
          
          echo "=== COPIED FILES ==="
          $copiedFiles | ForEach-Object { echo "✅ $_" }
          
          echo "=== FINAL PACKAGE CONTENTS ==="
          Get-ChildItem "Installer\SbiePlus_x64\" -Name | Sort-Object
          
          # Kiểm tra file quan trọng
          $criticalFiles = @("SbieDll.dll", "SbieSvc.exe", "Start.exe", "SbieDrv.sys")
          $missingFiles = @()
          
          foreach ($file in $criticalFiles) {
            if (Test-Path "Installer\SbiePlus_x64\$file") {
              echo "✅ $file - PRESENT"
            } else {
              echo "❌ $file - MISSING"
              $missingFiles += $file
            }
          }
          
          # Nếu thiếu file quan trọng, tạo error
          if ($missingFiles.Count -gt 0) {
            echo "::error::MISSING CRITICAL FILES: $($missingFiles -join ', ')"
            exit 1
          }

    #
    # Upload Artifacts
    #

      - name: Upload Sandboxie x64
        uses: actions/upload-artifact@v4
        with:
          name: Sandboxie_x64
          path: |
            Installer/SbiePlus_x64/*
          retention-days: 60
