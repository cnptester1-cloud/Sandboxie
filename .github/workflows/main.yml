name: CI Fixed Complete

on:
  workflow_dispatch:

env:
  WINDOWS_SDK_VERSION: 10.0

jobs:
  Build_x64:
    runs-on: windows-latest
    timeout-minutes: 60

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Build Tools
        run: |
          echo "=== Available Tools ==="
          echo "MSBuild: $(where msbuild)"
          echo "NuGet: $(where nuget)"
          echo "7z: C:\Program Files\7-Zip\7z.exe"

      - name: Setup msbuild
        uses: microsoft/setup-msbuild@v2

      - name: Setup NuGet
        uses: nuget/setup-nuget@v1
        with:
          nuget-version: 'latest'

    #
    # Compile Sandboxie Core
    #

      - name: Build Sandboxie x86 (DLLs & svc)
        run: msbuild /t:build Sandboxie\SandboxDll.sln /p:Configuration="SbieRelease" /p:Platform=Win32 -maxcpucount:8

      - name: Build Sandboxie x64 (all)
        run: msbuild /t:build Sandboxie\Sandbox.sln /p:Configuration="SbieRelease" /p:Platform=x64 -maxcpucount:8

    #
    # Build SbieShell với NuGet Fix
    #

      - name: Restore NuGet Packages for SbieShell
        run: |
          echo "=== Restoring NuGet Packages ==="
          nuget restore SandboxiePlus\SbieShell\SbieShell.sln
          
          # Kiểm tra package đã được restore
          if (Test-Path "SandboxiePlus\SbieShell\packages") {
            echo "Packages restored successfully"
            dir "SandboxiePlus\SbieShell\packages"
          }

      - name: Build SbieShell x64
        run: |
          msbuild SandboxiePlus\SbieShell\SbieShell.sln `
            /t:build `
            /p:Configuration="Release" `
            /p:Platform=x64 `
            /p:WindowsTargetPlatformVersion=${{ env.WINDOWS_SDK_VERSION }} `
            /p:PlatformToolset=v143 `
            -maxcpucount:4

    #
    # Build Sandboxie Tools
    #

      - name: Build Sandboxie-Tools x64
        run: msbuild /t:build SandboxieTools\SandboxieTools.sln /p:Configuration="Release" /p:Platform=x64 -maxcpucount:8

    #
    # Build Sandboxie Plus UI (Qt) - Optional
    #

      - name: Find and Build Qt UI
        run: |
          echo "=== Looking for Qt ==="
          $qtPaths = @(
            "C:\Qt\5.15.2\msvc2019_64",
            "C:\Qt\5.15.2\msvc2019", 
            "C:\Qt\6.5.0\msvc2019_64"
          )
          
          $foundQt = $false
          foreach ($path in $qtPaths) {
            if (Test-Path "$path\bin\qmake.exe") {
              echo "Found Qt at: $path"
              & "$path\bin\qmake.exe" SandboxiePlus\SandboxiePlus.pro -spec win32-msvc
              
              if (Get-Command jom -ErrorAction SilentlyContinue) {
                jom
              } else {
                msbuild release\SandboxiePlus.vcxproj /p:Configuration=Release
              }
              
              $foundQt = $true
              break
            }
          }
          
          if (-not $foundQt) {
            echo "Qt not found, building core components only..."
          }

    #
    # Merge everything together
    #

      - name: Create Build Directory
        run: |
          if (!(Test-Path "Installer\SbiePlus_x64")) { 
            New-Item -ItemType Directory -Path "Installer\SbiePlus_x64" -Force 
          }
          
          echo "=== Copying built files ==="
          
          # Copy core files
          if (Test-Path "bin\x64\SbieRelease") {
            copy "bin\x64\SbieRelease\*" "Installer\SbiePlus_x64\" -Recurse -Force
          }
          if (Test-Path "bin\Win32\SbieRelease") {
            copy "bin\Win32\SbieRelease\*" "Installer\SbiePlus_x64\" -Recurse -Force
          }
          
          # Copy SbieShell
          if (Test-Path "SandboxiePlus\SbieShell\x64\Release") {
            copy "SandboxiePlus\SbieShell\x64\Release\*" "Installer\SbiePlus_x64\" -Recurse -Force
          }
          
          # Copy Tools
          if (Test-Path "SandboxieTools\x64\Release") {
            copy "SandboxieTools\x64\Release\*" "Installer\SbiePlus_x64\" -Recurse -Force
          }
          
          # Copy Qt UI (nếu có)
          if (Test-Path "release\SandboxiePlus.exe") {
            copy "release\SandboxiePlus.exe" "Installer\SbiePlus_x64\SbiePlus.exe" -Force
          }

    #
    # Upload Artifacts
    #

      - name: Upload Sandboxie x64
        uses: actions/upload-artifact@v4
        with:
          name: Sandboxie_x64
          path: |
            Installer/SbiePlus_x64/*
          retention-days: 60

  Build_x86:
    runs-on: windows-latest
    timeout-minutes: 45

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup msbuild
        uses: microsoft/setup-msbuild@v2

      - name: Setup NuGet
        uses: nuget/setup-nuget@v1

      - name: Build Sandboxie x86 (all)
        run: msbuild /t:build Sandboxie\Sandbox.sln /p:Configuration="SbieRelease" /p:Platform=Win32 -maxcpucount:8

      - name: Restore NuGet Packages for SbieShell x86
        run: nuget restore SandboxiePlus\SbieShell\SbieShell.sln

      - name: Build SbieShell x86
        run: |
          msbuild SandboxiePlus\SbieShell\SbieShell.sln `
            /t:build `
            /p:Configuration="Release" `
            /p:Platform=x86 `
            /p:WindowsTargetPlatformVersion=${{ env.WINDOWS_SDK_VERSION }} `
            /p:PlatformToolset=v143

      - name: Build Sandboxie-Tools x86
        run: msbuild /t:build SandboxieTools\SandboxieTools.sln /p:Configuration="Release" /p:Platform=x86 -maxcpucount:8

      - name: Create x86 Package
        run: |
          if (!(Test-Path "Installer\SbiePlus_x86")) { 
            New-Item -ItemType Directory -Path "Installer\SbiePlus_x86" -Force 
          }
          
          copy "bin\Win32\SbieRelease\*" "Installer\SbiePlus_x86\" -Recurse -Force
          copy "SandboxiePlus\SbieShell\Win32\Release\*" "Installer\SbiePlus_x86\" -Recurse -Force
          copy "SandboxieTools\Win32\Release\*" "Installer\SbiePlus_x86\" -Recurse -Force

      - name: Upload Sandboxie x86
        uses: actions/upload-artifact@v4
        with:
          name: Sandboxie_x86
          path: |
            Installer/SbiePlus_x86/*
          retention-days: 60
