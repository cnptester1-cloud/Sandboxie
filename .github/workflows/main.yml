name: CI Fixed

on:
  workflow_dispatch:

env:
  qt_version: 5.15.2
  openssl_version: 3.2.1

jobs:
  Build_x64:
    runs-on: windows-latest
    timeout-minutes: 60

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Windows SDK
        run: |
          # Kiểm tra SDK có sẵn
          echo "Available SDKs:"
          dir "C:\Program Files (x86)\Windows Kits\10\bin\*"
          
      - name: Setup msbuild
        uses: microsoft/setup-msbuild@v2

    #
    # Compile Sandboxie Core
    #

      - name: Build Sandboxie x86 (DLLs & svc)
        run: msbuild /t:build Sandboxie\SandboxDll.sln /p:Configuration="SbieRelease" /p:Platform=Win32 -maxcpucount:8

      - name: Build Sandboxie x64 (all)
        run: msbuild /t:build Sandboxie\Sandbox.sln /p:Configuration="SbieRelease" /p:Platform=x64 -maxcpucount:8

    #
    # Prepare Qt Framework
    #

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{ env.qt_version }}
          arch: 'win64_msvc2019_64'
          cache: true

      - name: Setup Qt Environment
        run: |
          echo "QTDIR=$env:QT_ROOT" | Out-File -FilePath $env:GITHUB_ENV -Append

    #
    # Compile Sandboxie Plus - FIXED SDK VERSION
    #

      - name: Build Sandboxie-Plus x64
        run: |
          $env:QTDIR="$env:QT_ROOT"
          & "$env:QTDIR\bin\qmake.exe" SandboxiePlus\SandboxiePlus.pro -spec win32-msvc
          jom

      - name: Build SbieShell x64 (Fixed SDK)
        run: |
          # Build với SDK version có sẵn
          msbuild SandboxiePlus\SbieShell\SbieShell.sln ^
            /p:Configuration="Release" ^
            /p:Platform=x64 ^
            /p:WindowsTargetPlatformVersion=10.0 ^
            /p:PlatformToolset=v143

    #
    # Compile Sandboxie Tools
    #

      - name: Build Sandboxie-Tools x64
        run: msbuild /t:build SandboxieTools\SandboxieTools.sln /p:Configuration="Release" /p:Platform=x64 -maxcpucount:8

    #
    # Merge everything together
    #

      - name: Merging Build
        run: |
          if (!(Test-Path "Installer\SbiePlus_x64")) { New-Item -ItemType Directory -Path "Installer\SbiePlus_x64" -Force }
          
          # Copy core files
          copy "bin\x64\SbieRelease\*" "Installer\SbiePlus_x64\" -Recurse -Force
          copy "bin\Win32\SbieRelease\*" "Installer\SbiePlus_x64\" -Recurse -Force
          
          # Copy Qt files
          copy "$env:QT_ROOT\bin\*.dll" "Installer\SbiePlus_x64\" -Force
          
          # Copy Sandboxie Plus
          copy "release\SandboxiePlus.exe" "Installer\SbiePlus_x64\SbiePlus.exe" -Force

      - name: Upload Sandboxie x64
        uses: actions/upload-artifact@v4
        with:
          name: Sandboxie_x64
          path: |
            Installer/SbiePlus_x64/*
          retention-days: 60
